import pytest
import time
import yaml
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service



# библиотеки для скачивания драйверов браузеров
from webdriver_manager.firefox import GeckoDriverManager
from webdriver_manager.chrome import ChromeDriverManager


class Site:
    # проверка на то какой браузер используется в тесте
    def ＿init＿(self, browser, address):
        self.address = address
        if browser = "firefox":
            service = Service(executable_path=GeckoDriverManager().install())
            options = webdriver.Firefox
            options()
            self.driver = webdriver.Firefox(service=service, options=options)
        elif browser = "chrome":
            service = Service(executable_path=ChromeDriverManager().install())
            options = webdriver.ChromeOptions()
            self.driver = webdriver.Chrome(service=service, options=options)

        self.driver.implicitly_wait(3)
        self.driver.maximize_window()
        self.driver.get(address)
        time.sleep(testdata["sleep_time"])

    def find_element(self, mode, path):
        if mode == "css":
            element = self.driver.find_element(By.CSS_SELECTOR, path)
        elif mode == "xpath":
            element = self.driver.find_element(By.XPATH, path)
        else:
            element = None
        return element

    def get_element_property(self, mode, path, property):
        element = self.find_element(mode, path)
        return element.value_of_css_property(property)

    def go_to_site(self):
        return self.driver.get(self.address)

    def close(self):
        self.driver.close()

# файл конфигурации теста
with open("./testdata.yaml") as f:
    testdata = yaml.safe_load(f)
    browser = testdata["browser"]
    username = testdata['user_name']
    passwd = testdata['passwd']


def test_step1():
    # Тест при не правильном вводе данных пользователя
    x_selector1 = """//*[@id="login"]/div[1]/label/input""" # вводим Username
    input1 = Site.find_element("xpath", x_selector1)
    input1.send_keys("test")

    x_selector2 = """//*[@id="login"]/div[2]/label/input"""  # вводим passwd
    input2 = Site.find_element("xpath", x_selector2)
    input2.send_keys("test")

    btn_selector = "button"
    btn = Site.find_element("css", btn_selector)
    btn.click()

    x_selector3 = """//*[@id="app"]/main/div/div/div[2]/h2""" # Поиск сообщения об ошибке после неверного ввода
    err_label = Site.find_element("xpath", x_selector3)
    assert err_label.text() == "401"

def test_step2():
    # Тест при правильном вводе данных пользователя
    x_selector1 = """//*[@id="login"]/div[1]/label/input""" # вводим Username
    input1 = Site.find_element("xpath", x_selector1)
    input1.send_keys(username)

    x_selector2 = """//*[@id="login"]/div[2]/label/input"""  # вводим passwd
    input2 = Site.find_element("xpath", x_selector2)
    input2.send_keys(passwd)

    btn_selector = "button"
    btn = Site.find_element("css", btn_selector)
    btn.click()

    x_selector3 = """//*[@id="app"]/main/div/div[1]/h1"""
    flag_text_blog = Site.find_element("xpath", x_selector3)
    assert flag_text_blog.text() == "Blog"

